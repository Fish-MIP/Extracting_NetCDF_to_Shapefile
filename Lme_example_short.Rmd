---
title: "Extracting NetCDF data into Shapefiles"
author: "Julia Blanchard"
date: "27/01/2022"
output: html_document
---


This is some example R script that I find useful for extracting data from FishMIP or ISIMIP NetCDF files into shapefiles, such as Large Marine Ecosystems (LMEs), Country EEZs, or regional seas.

First, we will examine a NetCDF file already downloaded from the ISIMIP data portal (data.isimip.org). The filename has a lot of information in it! It is the netcdf of total catches (tc) from EcoOcean in the 3b simulation round of FishMIP, during the historical period (hist).

The modelled netcdf files were downloaded from ISIMIP data portal.


```{r setup, include=FALSE}
#install.packages("ncdf4")
#install.packages("raster")
#install.packages("sf")
library(ncdf4)
library(raster)
library(sf)
library(dplyr)
library(ggplot2)
```


### LME and raster LME

The LME shapefiles were downloaded from:https://www.sciencebase.gov/catalog/item/55c77722e4b08400b1fd8244



```{r setup, include=FALSE}
# read in shapefile
shape<-st_read("/Users/juliab6/Dropbox/FishMIP 2020:21/FishMIP Repos/LME66/LMEs66.shp")


# read in netcdf
boats<-brick("boats_ipsl-cm6a-lr_nobasd_historical_histsoc_default_tc_global_monthly_1950_2014.nc")

extent(boats) <- extent(shape)
crs(boats) <- crs(shape) 

```

A plot of the raster map of catches is here:


```{r}
dim(boats) # dimensions x,y, time steps
plot(boats[[780]])
```

### Crop it and mask the catches to the lmes

```{r}
temp<-crop(boats, extent(shape))
boats_lme<-mask(boats, shape)
plot(boats_lme[[780]])
```
### Convert to df


```{r}
library(dplyr)
se_aus<-shape[42,]
temp<-crop(boats, extent(se_aus))
boats_seaus<-mask(boats, se_aus)
plot(boats_seaus[[780]])



```

Get time series by LME

```{r}
# Rasterize polygon shapefile.
lme <-
  as(st_geometry(shape), 'Spatial')
lme <- rasterize(lme, boats,
  background = 0,
  filename = 'lme.grd',
  overwrite = TRUE)

crs(lme) <- crs(boats)
boats_lme <- crop(boats,lme)
boats_lme_ts<-zonal(boats_lme,lme, "mean")

# check dimensions
dim(boats_lme_ts)
plot(boats_lme_ts[1,])
```



### Other method using stars and sf packages

```{r}
#install.packages("stars")
#install.packages("sf")
library(stars)
library(sf)

stars_object <- raster::raster("ecoocean_ipsl-cm6a-lr_nobasd_historical_histsoc_default_tc_global_monthly_1950_2014.nc") %>% st_as_stars()

plot(stars_object)

sf_object <- sf::st_read("LMEs66.shp")

#Make sure they have the same CRS
sf::st_crs(stars_object) <- sf::st_crs(sf_object)

plot(sf_object)

stars_object <- stars_object[42]

#plot
ggplot()+
  geom_stars(data = stars_object) +
  geom_sf(data = shape)
```
